<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cadastrar Cliente - Celidone</title>
        <link rel="stylesheet" href="../css/forms.css" />
        <link rel="stylesheet" href="../css/cliente.css" />
        <link rel="stylesheet" href="../css/shared.css" />
    </head>
    <body class="modern-theme">
        <div class="container">
            <!-- Header -->
            <header class="page-header">
                <div class="header-content">
                    <div class="header-left">
                        <img
                            src="../img/bowTie2.png"
                            alt="Celidone"
                            class="logo-small"
                        />
                        <h1 class="page-title">Cadastrar Cliente</h1>
                    </div>
                    <div class="header-actions">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="window.close()"
                        >
                            <span class="icon">✕</span> Fechar
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content">
                <div class="form-container">
                    <form id="cliente-form" class="modern-form">
                        <!-- Dados Pessoais -->
                        <fieldset class="form-section">
                            <legend>Dados Pessoais</legend>

                            <div class="form-row">
                                <div class="form-group col-md-8">
                                    <label for="nome" class="required"
                                        >Nome Completo</label
                                    >
                                    <input
                                        type="text"
                                        id="nome"
                                        name="nome"
                                        class="form-control"
                                        required
                                        placeholder="Digite o nome completo"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="cpf" class="required"
                                        >CPF</label
                                    >
                                    <input
                                        type="text"
                                        id="cpf"
                                        name="cpf"
                                        class="form-control"
                                        required
                                        placeholder="000.000.000-00"
                                        maxlength="14"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="email" class="required"
                                        >E-mail</label
                                    >
                                    <input
                                        type="email"
                                        id="email"
                                        name="email"
                                        class="form-control"
                                        required
                                        placeholder="exemplo@email.com"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="telefone" class="required"
                                        >Telefone</label
                                    >
                                    <input
                                        type="tel"
                                        id="telefone"
                                        name="telefone"
                                        class="form-control"
                                        required
                                        placeholder="(11) 99999-9999"
                                        maxlength="15"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="data-nascimento"
                                        >Data de Nascimento</label
                                    >
                                    <input
                                        type="date"
                                        id="data-nascimento"
                                        name="dataNascimento"
                                        class="form-control"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="rg">RG</label>
                                    <input
                                        type="text"
                                        id="rg"
                                        name="rg"
                                        class="form-control"
                                        placeholder="00.000.000-0"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Endereço -->
                        <fieldset class="form-section">
                            <legend>Endereço</legend>

                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label for="cep" class="required"
                                        >CEP</label
                                    >
                                    <input
                                        type="text"
                                        id="cep"
                                        name="cep"
                                        class="form-control"
                                        required
                                        placeholder="00000-000"
                                        maxlength="9"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="logradouro" class="required"
                                        >Logradouro</label
                                    >
                                    <input
                                        type="text"
                                        id="logradouro"
                                        name="logradouro"
                                        class="form-control"
                                        required
                                        placeholder="Rua, Avenida, etc."
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="numero" class="required"
                                        >Número</label
                                    >
                                    <input
                                        type="text"
                                        id="numero"
                                        name="numero"
                                        class="form-control"
                                        required
                                        placeholder="123"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="complemento">Complemento</label>
                                    <input
                                        type="text"
                                        id="complemento"
                                        name="complemento"
                                        class="form-control"
                                        placeholder="Apt, Casa, etc."
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="bairro" class="required"
                                        >Bairro</label
                                    >
                                    <input
                                        type="text"
                                        id="bairro"
                                        name="bairro"
                                        class="form-control"
                                        required
                                        placeholder="Nome do bairro"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                                <div class="form-group col-md-4">
                                    <label for="cidade" class="required"
                                        >Cidade</label
                                    >
                                    <input
                                        type="text"
                                        id="cidade"
                                        name="cidade"
                                        class="form-control"
                                        required
                                        placeholder="Nome da cidade"
                                    />
                                    <div class="field-feedback"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="estado" class="required"
                                        >Estado</label
                                    >
                                    <select
                                        id="estado"
                                        name="estado"
                                        class="form-control"
                                        required
                                    >
                                        <option value="">Selecione...</option>
                                        <option value="AC">Acre</option>
                                        <option value="AL">Alagoas</option>
                                        <option value="AP">Amapá</option>
                                        <option value="AM">Amazonas</option>
                                        <option value="BA">Bahia</option>
                                        <option value="CE">Ceará</option>
                                        <option value="DF">
                                            Distrito Federal
                                        </option>
                                        <option value="ES">
                                            Espírito Santo
                                        </option>
                                        <option value="GO">Goiás</option>
                                        <option value="MA">Maranhão</option>
                                        <option value="MT">Mato Grosso</option>
                                        <option value="MS">
                                            Mato Grosso do Sul
                                        </option>
                                        <option value="MG">Minas Gerais</option>
                                        <option value="PA">Pará</option>
                                        <option value="PB">Paraíba</option>
                                        <option value="PR">Paraná</option>
                                        <option value="PE">Pernambuco</option>
                                        <option value="PI">Piauí</option>
                                        <option value="RJ">
                                            Rio de Janeiro
                                        </option>
                                        <option value="RN">
                                            Rio Grande do Norte
                                        </option>
                                        <option value="RS">
                                            Rio Grande do Sul
                                        </option>
                                        <option value="RO">Rondônia</option>
                                        <option value="RR">Roraima</option>
                                        <option value="SC">
                                            Santa Catarina
                                        </option>
                                        <option value="SP">São Paulo</option>
                                        <option value="SE">Sergipe</option>
                                        <option value="TO">Tocantins</option>
                                    </select>
                                    <div class="field-feedback"></div>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Observações -->
                        <fieldset class="form-section">
                            <legend>Informações Adicionais</legend>

                            <div class="form-group">
                                <label for="observacoes">Observações</label>
                                <textarea
                                    id="observacoes"
                                    name="observacoes"
                                    class="form-control"
                                    rows="3"
                                    placeholder="Informações complementares sobre o cliente"
                                ></textarea>
                                <div class="field-feedback"></div>
                            </div>
                        </fieldset>

                        <!-- Actions -->
                        <div class="form-actions">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                onclick="limparFormulario()"
                            >
                                <span class="icon">🗑️</span> Limpar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <span class="icon">💾</span> Cadastrar Cliente
                            </button>
                        </div>
                    </form>
                </div>
            </main>

            <!-- Loading Overlay -->
            <div
                id="loading-overlay"
                class="loading-overlay"
                style="display: none"
            >
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Processando...</p>
                </div>
            </div>

            <!-- Notification Area -->
            <div id="notification-area" class="notification-area"></div>
        </div>

        <!-- Scripts -->
        <script src="../scripts/cliente.scripts.js"></script>
        <script>
            // Inicialização específica para cadastro
            document.addEventListener("DOMContentLoaded", function () {
                console.log("Página de cadastro de cliente carregada");

                // Foco no primeiro campo
                document.getElementById("nome").focus();

                // Configurar máscaras
                setupMasks();

                // Configurar validações
                setupValidations();

                // Configurar busca CEP
                setupCepSearch();
            });

            function limparFormulario() {
                document.getElementById("cliente-form").reset();
                document.getElementById("nome").focus();

                // Limpar feedbacks
                document.querySelectorAll(".field-feedback").forEach((el) => {
                    el.textContent = "";
                    el.className = "field-feedback";
                });
            }

            function setupMasks() {
                // Máscara CPF
                const cpfInput = document.getElementById("cpf");
                cpfInput.addEventListener("input", function (e) {
                    let value = e.target.value.replace(/\D/g, "");
                    value = value.replace(/(\d{3})(\d)/, "$1.$2");
                    value = value.replace(/(\d{3})(\d)/, "$1.$2");
                    value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
                    e.target.value = value;
                });

                // Máscara Telefone
                const telefoneInput = document.getElementById("telefone");
                telefoneInput.addEventListener("input", function (e) {
                    let value = e.target.value.replace(/\D/g, "");
                    value = value.replace(/(\d{2})(\d)/, "($1) $2");
                    value = value.replace(/(\d{4,5})(\d{4})$/, "$1-$2");
                    e.target.value = value;
                });

                // Máscara CEP
                const cepInput = document.getElementById("cep");
                cepInput.addEventListener("input", function (e) {
                    let value = e.target.value.replace(/\D/g, "");
                    value = value.replace(/(\d{5})(\d)/, "$1-$2");
                    e.target.value = value;
                });
            }

            function setupValidations() {
                const form = document.getElementById("cliente-form");
                form.addEventListener("submit", function (e) {
                    e.preventDefault();

                    if (validateForm()) {
                        submitForm();
                    }
                });
            }

            function validateForm() {
                let isValid = true;

                // Validar campos obrigatórios
                const requiredFields = form.querySelectorAll("[required]");
                requiredFields.forEach((field) => {
                    if (!field.value.trim()) {
                        showFieldError(field, "Este campo é obrigatório");
                        isValid = false;
                    } else {
                        clearFieldError(field);
                    }
                });

                // Validar CPF
                const cpf = document.getElementById("cpf").value;
                if (cpf && !isValidCPF(cpf)) {
                    showFieldError(
                        document.getElementById("cpf"),
                        "CPF inválido"
                    );
                    isValid = false;
                }

                // Validar email
                const email = document.getElementById("email").value;
                if (email && !isValidEmail(email)) {
                    showFieldError(
                        document.getElementById("email"),
                        "E-mail inválido"
                    );
                    isValid = false;
                }

                return isValid;
            }

            function showFieldError(field, message) {
                const feedback =
                    field.parentElement.querySelector(".field-feedback");
                feedback.textContent = message;
                feedback.className = "field-feedback error";
                field.classList.add("error");
            }

            function clearFieldError(field) {
                const feedback =
                    field.parentElement.querySelector(".field-feedback");
                feedback.textContent = "";
                feedback.className = "field-feedback";
                field.classList.remove("error");
            }

            function isValidCPF(cpf) {
                cpf = cpf.replace(/\D/g, "");
                if (cpf.length !== 11) return false;
                if (/^(\d)\1{10}$/.test(cpf)) return false;

                let sum = 0;
                for (let i = 0; i < 9; i++) {
                    sum += parseInt(cpf.charAt(i)) * (10 - i);
                }
                let digit = 11 - (sum % 11);
                if (digit === 10 || digit === 11) digit = 0;
                if (digit !== parseInt(cpf.charAt(9))) return false;

                sum = 0;
                for (let i = 0; i < 10; i++) {
                    sum += parseInt(cpf.charAt(i)) * (11 - i);
                }
                digit = 11 - (sum % 11);
                if (digit === 10 || digit === 11) digit = 0;
                return digit === parseInt(cpf.charAt(10));
            }

            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            function setupCepSearch() {
                const cepInput = document.getElementById("cep");
                cepInput.addEventListener("blur", function () {
                    const cep = this.value.replace(/\D/g, "");
                    if (cep.length === 8) {
                        buscarCEP(cep);
                    }
                });
            }

            async function buscarCEP(cep) {
                try {
                    showLoading(true);
                    const response = await window.api.buscarCep(cep);

                    if (response.success) {
                        const data = response.data;
                        document.getElementById("logradouro").value =
                            data.logradouro || "";
                        document.getElementById("bairro").value =
                            data.bairro || "";
                        document.getElementById("cidade").value =
                            data.localidade || "";
                        document.getElementById("estado").value = data.uf || "";
                    }
                } catch (error) {
                    console.error("Erro ao buscar CEP:", error);
                } finally {
                    showLoading(false);
                }
            }

            async function submitForm() {
                try {
                    showLoading(true);

                    const formData = new FormData(
                        document.getElementById("cliente-form")
                    );
                    const clienteData = Object.fromEntries(formData.entries());

                    const response = await window.api.cadastrarCliente(
                        clienteData
                    );

                    if (response.success) {
                        showNotification(
                            "Cliente cadastrado com sucesso!",
                            "success"
                        );
                        setTimeout(() => {
                            limparFormulario();
                        }, 1500);
                    } else {
                        showNotification(
                            response.error || "Erro ao cadastrar cliente",
                            "error"
                        );
                    }
                } catch (error) {
                    showNotification("Erro interno: " + error.message, "error");
                } finally {
                    showLoading(false);
                }
            }

            function showLoading(show) {
                document.getElementById("loading-overlay").style.display = show
                    ? "flex"
                    : "none";
            }

            function showNotification(message, type = "info") {
                const notification = document.createElement("div");
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                <span class="notification-icon">${
                    type === "success" ? "✅" : type === "error" ? "❌" : "ℹ️"
                }</span>
                <span class="notification-message">${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;

                document
                    .getElementById("notification-area")
                    .appendChild(notification);

                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
        </script>
    </body>
</html>
